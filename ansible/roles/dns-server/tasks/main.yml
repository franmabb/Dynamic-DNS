# tasks/main.yml (dns_server)
---
- name: Instalar BIND9
  apt:
    name: bind9
    state: present
    update_cache: yes

- name: Generar Clave TSIG para DDNS
  # Usaremos 'command' para generar la clave y guardarla en una variable
  # Nota: tsig-keygen requiere el paquete dnsutils
  command: tsig-keygen -a hmac-sha256 ddns-key
  register: tsig_key_output
  changed_when: true

- name: Guardar Clave TSIG para usarla en el rol DHCP
  # La clave se guardará en un archivo temporal para ser leída por el siguiente rol
  local_action: copy
    content: "{{ tsig_key_output.stdout }}"
    dest: "{{ playbook_dir }}/temp_ddns.key"
  run_once: true

- name: Configurar named.conf.options con la clave TSIG
  template:
    src: named.conf.options.j2
    dest: /etc/bind/named.conf.options
    mode: '0644'
  notify: Restart bind9

- name: Configurar named.conf.local (zonas)
  template:
    src: named.conf.local.j2
    dest: /etc/bind/named.conf.local
    mode: '0644'
  notify: Restart bind9

# Aquí irían otras tareas para copiar y configurar los archivos de zona db.example.test y db.192

- name: Handler para reiniciar bind9
  service:
    name: bind9
    state: restarted
  listen: "Restart bind9"